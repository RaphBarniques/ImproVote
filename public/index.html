<!-- public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Voting</title>
</head>
<body>
  <h1>Vote for an Option</h1>
  <div id="btnPanel">
    <button onclick="vote('option1')" id="button1" class="button">Option 1</button>
    <button onclick="vote('option2')" id="button2" class="button">Option 2</button>
  </div>

  <div id="messagePanel" style="display: none;">
    <h3>Vote for <strong id="vote">Vote</strong> submitted</h3>
    <h3>Waiting for next vote</h3>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
  <script>
    const socket = io({
      query: {
        participantId: localStorage.getItem('participantId'),
      },
    });
    let socketId;
    socket.on('connect', () => {
        socketId = socket.id;
        console.log(socketId);
      });

    // Request poll status from the server when the page loads
    socket.emit('get-poll-status', { participantId: localStorage.getItem('participantId'), socketId});

    // If participant doesn't have an ID, set it
    socket.on('set-cookie', ({ participantId, hasVoted }) => {
      localStorage.setItem('participantId', participantId);
      localStorage.setItem('hasVoted', hasVoted);
    });

    socket.on('poll-status', (isOpen) => {
    const hasVoted = localStorage.getItem('hasVoted')
      if (isOpen) {
        openVote();
      } else {
        closeVote();
      }
    });

    function openVote() {
      document.getElementById("btnPanel").style.display = "block";
      document.getElementById("messagePanel").style.display = "none";
    }

    function closeVote() {
      document.getElementById("btnPanel").style.display = "none";
      document.getElementById("messagePanel").style.display = "block";
    }

    function vote(option) {
      const participantId = localStorage.getItem('participantId');
      const hasVoted = localStorage.getItem('hasVoted') === 'true';

      // Send the vote and participant ID to the server
      socket.emit('vote', { option, participantId, socketId });

      if (!hasVoted) {
        // Set hasVoted to true in localStorage
        localStorage.setItem('hasVoted', true);
      }
      document.getElementById("vote").innerText = option;
    }

    socket.on('reset', () => {
      openVote();
      localStorage.setItem('hasVoted', false);
      console.log("Votes reset");
    });

    // Check if the participant has already voted
    socket.on('check-vote-status', ({ participantId, hasVoted }) => {
      if (hasVoted) {
        closeVote();
      } else {
        openVote();
      }
    });
  </script>
</body>
</html>
